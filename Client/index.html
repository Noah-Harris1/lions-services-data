<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="theme-color" content="#1D2125" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#1D2125" media="(prefers-color-scheme: dark)">

  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="Client/src/Assets/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ReactReduxRouterVite-Starter</title>
</head>

<body>
  <div id="video-container">
    <video id="qr-video" disablepictureinpicture="" playsinline="" style="transform: scaleX(-1);"></video>
    <div class="scan-region-highlight"
      style="position: absolute; pointer-events: none; transform: scaleX(-1); width: 0px; height: 0px; top: 0px; left: 0px;">
      <svg class="scan-region-highlight-svg" viewBox="0 0 238 238" preserveAspectRatio="none"
        style="position:absolute;width:100%;height:100%;left:0;top:0;fill:none;stroke:#e9b213;stroke-width:4;stroke-linecap:round;stroke-linejoin:round">
        <path
          d="M31 2H10a8 8 0 0 0-8 8v21M207 2h21a8 8 0 0 1 8 8v21m0 176v21a8 8 0 0 1-8 8h-21m-176 0H10a8 8 0 0 1-8-8v-21">
        </path>
      </svg><svg class="code-outline-highlight" preserveAspectRatio="none"
        style="display:none;width:100%;height:100%;fill:none;stroke:#e9b213;stroke-width:5;stroke-dasharray:25;stroke-linecap:round;stroke-linejoin:round">
        <polygon></polygon>
      </svg>
    </div>
  </div>

  <div>
    <b>Preferred camera:</b>
    <select id="cam-list">
      <option value="environment" selected="">Environment Facing (default)</option>
      <option value="user">User Facing</option>
      <option value="3414a878d5e55b13dabb338621fd75e2a9a625df8e03358641a46a47909f7e8f">USB Live camera (0c45:6366)</option>
    </select>
  </div>

  <span id="cam-qr-result" style="color: inherit;">No QR code found</span>

  <span id="cam-qr-result-timestamp"></span>

  <script type="module">
    import QrScanner from "./qr-scanner.min.js";

    const video = document.getElementById('qr-video');
    const videoContainer = document.getElementById('video-container');
    const camHasCamera = document.getElementById('cam-has-camera');
    const camList = document.getElementById('cam-list');
    const camHasFlash = document.getElementById('cam-has-flash');
    const flashToggle = document.getElementById('flash-toggle');
    const flashState = document.getElementById('flash-state');
    const camQrResult = document.getElementById('cam-qr-result');
    const camQrResultTimestamp = document.getElementById('cam-qr-result-timestamp');
    const fileSelector = document.getElementById('file-selector');
    const fileQrResult = document.getElementById('file-qr-result');

    var audio = new Audio("src/Assets/beep.mp3");

    function setResult(label, result) {
      console.log(result.data);
      label.textContent = result.data;
      camQrResultTimestamp.textContent = new Date().toString();
      label.style.color = 'teal';
      audio.play();
      clearTimeout(label.highlightTimeout);
      label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 100);
      audio.volume = 1;

    }

    // ####### Web Cam Scanning #######

    const scanner = new QrScanner(video, result => setResult(camQrResult, result), {
      onDecodeError: error => {
        camQrResult.textContent = error;
        camQrResult.style.color = 'inherit';
      },
      highlightScanRegion: true,
      highlightCodeOutline: true,
      maxScansPerSecond: 1,
    });

    const updateFlashAvailability = () => {
      scanner.hasFlash().then(hasFlash => {
        camHasFlash.textContent = hasFlash;
        flashToggle.style.display = hasFlash ? 'inline-block' : 'none';
      });
    };

    scanner.start().then(() => {
      updateFlashAvailability();
      // List cameras after the scanner started to avoid listCamera's stream and the scanner's stream being requested
      // at the same time which can result in listCamera's unconstrained stream also being offered to the scanner.
      // Note that we can also start the scanner after listCameras, we just have it this way around in the demo to
      // start the scanner earlier.
      QrScanner.listCameras(true).then(cameras => cameras.forEach(camera => {
        const option = document.createElement('option');
        option.value = camera.id;
        option.text = camera.label;
        camList.add(option);
      }));
    });

    QrScanner.hasCamera().then(hasCamera => camHasCamera.textContent = hasCamera);

    // for debugging
    window.scanner = scanner;

    document.getElementById('scan-region-highlight-style-select').addEventListener('change', (e) => {
      videoContainer.className = e.target.value;
      scanner._updateOverlay(); // reposition the highlight because style 2 sets position: relative
    });

    document.getElementById('show-scan-region').addEventListener('change', (e) => {
      const input = e.target;
      const label = input.parentNode;
      label.parentNode.insertBefore(scanner.$canvas, label.nextSibling);
      scanner.$canvas.style.display = input.checked ? 'block' : 'none';
    });

    document.getElementById('inversion-mode-select').addEventListener('change', event => {
      scanner.setInversionMode(event.target.value);
    });

    camList.addEventListener('change', event => {
      scanner.setCamera(event.target.value).then(updateFlashAvailability);
    });

    flashToggle.addEventListener('click', () => {
      scanner.toggleFlash().then(() => flashState.textContent = scanner.isFlashOn() ? 'on' : 'off');
    });

    document.getElementById('start-button').addEventListener('click', () => {
      scanner.start();
    });

    document.getElementById('stop-button').addEventListener('click', () => {
      scanner.stop();
    });

    // ####### File Scanning #######

    fileSelector.addEventListener('change', event => {
      const file = fileSelector.files[0];
      if (!file) {
        return;
      }
      QrScanner.scanImage(file, { returnDetailedScanResult: true })
        .then(result => setResult(fileQrResult, result))
        .catch(e => setResult(fileQrResult, { data: e || 'No QR code found.' }));
    });
  </script>

  <style>
    div {
      margin-bottom: 16px;
    }

    #video-container {
      line-height: 0;
    }

    #video-container.example-style-1 .scan-region-highlight-svg,
    #video-container.example-style-1 .code-outline-highlight {
      stroke: #64a2f3 !important;
    }

    #video-container.example-style-2 {
      position: relative;
      width: max-content;
      height: max-content;
      overflow: hidden;
    }

    #video-container.example-style-2 .scan-region-highlight {
      border-radius: 30px;
      outline: rgba(0, 0, 0, .25) solid 50vmax;
    }

    #video-container.example-style-2 .scan-region-highlight-svg {
      display: none;
    }

    #video-container.example-style-2 .code-outline-highlight {
      stroke: rgba(255, 255, 255, .5) !important;
      stroke-width: 15 !important;
      stroke-dasharray: none !important;
    }

    #flash-toggle {
      display: none;
    }

    hr {
      margin-top: 32px;
    }

    input[type="file"] {
      display: block;
      margin-bottom: 16px;
    }
  </style>

</body>

<div id="root"></div>
<script type="module" src="/src/index.jsx"></script>

</html>